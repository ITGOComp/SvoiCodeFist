# Диаграмма архитектуры микросервисов

## Общая архитектура

```
┌─────────────────────────────────────────────────────────────────┐
│                        API Gateway                              │
│                    (FastAPI, Port 8000)                        │
└─────────────────────┬───────────────────────────────────────────┘
                      │
        ┌─────────────┼─────────────┐
        │             │             │
        ▼             ▼             ▼
┌─────────────┐ ┌─────────────┐ ┌─────────────┐
│User Service │ │Incident     │ │Traffic      │
│Port 8001    │ │Service      │ │Service      │
│             │ │Port 8002    │ │Port 8003    │
└─────────────┘ └─────────────┘ └─────────────┘
        │             │             │
        ▼             ▼             ▼
┌─────────────┐ ┌─────────────┐ ┌─────────────┐
│News Service │ │Chat Service │ │Analytics    │
│Port 8004    │ │Port 8005    │ │Service      │
│             │ │             │ │Port 8006    │
└─────────────┘ └─────────────┘ └─────────────┘
        │             │             │
        ▼             ▼             ▼
┌─────────────┐ ┌─────────────┐ ┌─────────────┐
│Traffic      │ │Schedule     │ │Notification │
│Analytics    │ │Service      │ │Service      │
│Service      │ │Port 8008    │ │Port 8009    │
│Port 8007    │ │             │ │             │
└─────────────┘ └─────────────┘ └─────────────┘
```

## Clean Architecture слои

```
┌─────────────────────────────────────────────────────────────┐
│                    Presentation Layer                       │
│  ┌─────────────┐ ┌─────────────┐ ┌─────────────┐          │
│  │Controllers  │ │Serializers  │ │Middleware   │          │
│  └─────────────┘ └─────────────┘ └─────────────┘          │
└─────────────────────────────────────────────────────────────┘
                              │
┌─────────────────────────────────────────────────────────────┐
│                   Application Layer                         │
│  ┌─────────────┐ ┌─────────────┐ ┌─────────────┐          │
│  │Use Cases    │ │DTOs         │ │Services     │          │
│  └─────────────┘ └─────────────┘ └─────────────┘          │
└─────────────────────────────────────────────────────────────┘
                              │
┌─────────────────────────────────────────────────────────────┐
│                     Domain Layer                            │
│  ┌─────────────┐ ┌─────────────┐ ┌─────────────┐          │
│  │Entities     │ │Value Objects│ │Domain       │          │
│  │             │ │             │ │Services     │          │
│  └─────────────┘ └─────────────┘ └─────────────┘          │
└─────────────────────────────────────────────────────────────┘
                              │
┌─────────────────────────────────────────────────────────────┐
│                 Infrastructure Layer                        │
│  ┌─────────────┐ ┌─────────────┐ ┌─────────────┐          │
│  │Repositories │ │External     │ │Database     │          │
│  │             │ │Services     │ │Models       │          │
│  └─────────────┘ └─────────────┘ └─────────────┘          │
└─────────────────────────────────────────────────────────────┘
```

## Базы данных

```
┌─────────────────────────────────────────────────────────────┐
│                    PostgreSQL Cluster                       │
│                                                             │
│  ┌─────────────┐ ┌─────────────┐ ┌─────────────┐          │
│  │User DB      │ │Incident DB  │ │Traffic DB   │          │
│  │             │ │             │ │(TimescaleDB)│          │
│  └─────────────┘ └─────────────┘ └─────────────┘          │
│                                                             │
│  ┌─────────────┐ ┌─────────────┐ ┌─────────────┐          │
│  │News DB      │ │Chat DB      │ │Analytics DB │          │
│  │             │ │             │ │             │          │
│  └─────────────┘ └─────────────┘ └─────────────┘          │
│                                                             │
│  ┌─────────────┐ ┌─────────────┐ ┌─────────────┐          │
│  │Traffic      │ │Schedule DB  │ │Notification │          │
│  │Analytics DB │ │             │ │DB           │          │
│  └─────────────┘ └─────────────┘ └─────────────┘          │
└─────────────────────────────────────────────────────────────┘
                              │
┌─────────────────────────────────────────────────────────────┐
│                    ClickHouse                               │
│              (Analytics Database)                           │
└─────────────────────────────────────────────────────────────┘
```

## Кэширование и очереди

```
┌─────────────────────────────────────────────────────────────┐
│                        Redis                                │
│                    (Cache & Sessions)                       │
└─────────────────────────────────────────────────────────────┘
                              │
┌─────────────────────────────────────────────────────────────┐
│                      RabbitMQ                               │
│                   (Message Queue)                           │
└─────────────────────────────────────────────────────────────┘
```

## Мониторинг

```
┌─────────────────────────────────────────────────────────────┐
│                    Prometheus                               │
│                   (Metrics Collection)                      │
└─────────────────────┬───────────────────────────────────────┘
                      │
┌─────────────────────┼───────────────────────────────────────┐
│                    Grafana                                  │
│                   (Dashboards)                              │
└─────────────────────┼───────────────────────────────────────┘
                      │
┌─────────────────────────────────────────────────────────────┐
│                    ELK Stack                                │
│  ┌─────────────┐ ┌─────────────┐ ┌─────────────┐          │
│  │Elasticsearch│ │Logstash     │ │Kibana       │          │
│  │             │ │             │ │             │          │
│  └─────────────┘ └─────────────┘ └─────────────┘          │
└─────────────────────────────────────────────────────────────┘
```

## Межсервисное взаимодействие

```
┌─────────────────────────────────────────────────────────────┐
│                  Synchronous Communication                  │
│                                                             │
│  ┌─────────────┐    HTTP/REST    ┌─────────────┐          │
│  │Service A    │◄──────────────►│Service B    │          │
│  └─────────────┘                 └─────────────┘          │
└─────────────────────────────────────────────────────────────┘
                              │
┌─────────────────────────────────────────────────────────────┐
│                 Asynchronous Communication                  │
│                                                             │
│  ┌─────────────┐    Events     ┌─────────────┐            │
│  │Service A    │──────────────►│Service B    │            │
│  └─────────────┘               └─────────────┘            │
│         │                             │                   │
│         ▼                             ▼                   │
│  ┌─────────────┐               ┌─────────────┐            │
│  │RabbitMQ     │               │Event Store  │            │
│  └─────────────┘               └─────────────┘            │
└─────────────────────────────────────────────────────────────┘
```

## Безопасность

```
┌─────────────────────────────────────────────────────────────┐
│                    Security Layer                           │
│                                                             │
│  ┌─────────────┐ ┌─────────────┐ ┌─────────────┐          │
│  │JWT Tokens   │ │Rate Limiting│ │HTTPS/TLS    │          │
│  │             │ │             │ │             │          │
│  └─────────────┘ └─────────────┘ └─────────────┘          │
│                                                             │
│  ┌─────────────┐ ┌─────────────┐ ┌─────────────┐          │
│  │Input        │ │Audit Logging│ │RBAC         │          │
│  │Validation   │ │             │ │             │          │
│  └─────────────┘ └─────────────┘ └─────────────┘          │
└─────────────────────────────────────────────────────────────┘
```

## Развертывание

```
┌─────────────────────────────────────────────────────────────┐
│                    Docker Compose                           │
│                                                             │
│  ┌─────────────┐ ┌─────────────┐ ┌─────────────┐          │
│  │Container A  │ │Container B  │ │Container C  │          │
│  │             │ │             │ │             │          │
│  └─────────────┘ └─────────────┘ └─────────────┘          │
│                                                             │
│  ┌─────────────┐ ┌─────────────┐ ┌─────────────┐          │
│  │Container D  │ │Container E  │ │Container F  │          │
│  │             │ │             │ │             │          │
│  └─────────────┘ └─────────────┘ └─────────────┘          │
└─────────────────────────────────────────────────────────────┘
                              │
┌─────────────────────────────────────────────────────────────┐
│                    Docker Network                           │
│              (microservices-network)                        │
└─────────────────────────────────────────────────────────────┘
```

