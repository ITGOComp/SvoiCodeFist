<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Управление микросервисами</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/css/bootstrap.min.css" rel="stylesheet">
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">
    <style>
        .service-card {
            transition: transform 0.2s;
        }
        .service-card:hover {
            transform: translateY(-2px);
        }
        .status-indicator {
            width: 12px;
            height: 12px;
            border-radius: 50%;
            display: inline-block;
            margin-right: 8px;
        }
        .status-healthy {
            background-color: #28a745;
        }
        .status-unhealthy {
            background-color: #dc3545;
        }
        .status-unknown {
            background-color: #6c757d;
        }
    </style>
</head>
<body>
    <div class="container-fluid">
        <div class="row">
            <div class="col-12">
                <nav class="navbar navbar-expand-lg navbar-dark bg-dark">
                    <div class="container-fluid">
                        <a class="navbar-brand" href="/">
                            <i class="fas fa-cogs"></i> Управление микросервисами
                        </a>
                        <div class="navbar-nav ms-auto">
                            <a class="nav-link" href="/">
                                <i class="fas fa-home"></i> Главная
                            </a>
                        </div>
                    </div>
                </nav>
            </div>
        </div>

        <div class="container mt-4">
            <!-- Control Panel -->
            <div class="row mb-4">
                <div class="col-12">
                    <div class="card">
                        <div class="card-header">
                            <h5 class="mb-0">
                                <i class="fas fa-sliders-h"></i> Панель управления
                            </h5>
                        </div>
                        <div class="card-body">
                            <div class="row">
                                <div class="col-md-6">
                                    <div class="d-grid gap-2">
                                        <button class="btn btn-success" onclick="enableMicroservices()">
                                            <i class="fas fa-play"></i> Включить микросервисы
                                        </button>
                                        <button class="btn btn-danger" onclick="disableMicroservices()">
                                            <i class="fas fa-stop"></i> Отключить микросервисы
                                        </button>
                                    </div>
                                </div>
                                <div class="col-md-6">
                                    <div class="d-grid gap-2">
                                        <button class="btn btn-info" onclick="refreshStatus()">
                                            <i class="fas fa-sync-alt"></i> Обновить статус
                                        </button>
                                        <button class="btn btn-warning" onclick="checkHealth()">
                                            <i class="fas fa-heartbeat"></i> Проверить здоровье
                                        </button>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Current Status -->
            <div class="row mb-4">
                <div class="col-12">
                    <div class="card">
                        <div class="card-header">
                            <h5 class="mb-0">
                                <i class="fas fa-info-circle"></i> Текущий статус
                            </h5>
                        </div>
                        <div class="card-body">
                            <div id="current-status">
                                <div class="text-center">
                                    <div class="spinner-border" role="status">
                                        <span class="visually-hidden">Загрузка...</span>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Services Grid -->
            <div class="row" id="services-grid">
                <!-- Services will be loaded here -->
            </div>
        </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/js/bootstrap.bundle.min.js"></script>
    <script>
        // Load initial data
        document.addEventListener('DOMContentLoaded', function() {
            loadCurrentStatus();
            loadServicesStatus();
        });

        function loadCurrentStatus() {
            fetch('/api/health/')
                .then(response => response.json())
                .then(data => {
                    const statusDiv = document.getElementById('current-status');
                    const healthyCount = Object.values(data.health).filter(status => status).length;
                    const totalCount = Object.keys(data.health).length;
                    
                    statusDiv.innerHTML = `
                        <div class="row">
                            <div class="col-md-6">
                                <h6>Режим работы:</h6>
                                <span class="badge bg-primary">Микросервисы</span>
                            </div>
                            <div class="col-md-6">
                                <h6>Статус сервисов:</h6>
                                <span class="badge ${healthyCount === totalCount ? 'bg-success' : 'bg-warning'}">
                                    ${healthyCount}/${totalCount} работают
                                </span>
                            </div>
                        </div>
                    `;
                })
                .catch(error => {
                    document.getElementById('current-status').innerHTML = `
                        <div class="alert alert-danger">
                            <i class="fas fa-exclamation-triangle"></i> Ошибка загрузки статуса
                        </div>
                    `;
                });
        }

        function loadServicesStatus() {
            fetch('/api/services/status/')
                .then(response => response.json())
                .then(data => {
                    const servicesGrid = document.getElementById('services-grid');
                    servicesGrid.innerHTML = '';
                    
                    Object.entries(data.services).forEach(([serviceName, info]) => {
                        const statusClass = info.healthy ? 'status-healthy' : 'status-unhealthy';
                        const statusText = info.healthy ? 'Работает' : 'Не работает';
                        const cardClass = info.healthy ? 'border-success' : 'border-danger';
                        
                        const serviceCard = document.createElement('div');
                        serviceCard.className = 'col-md-6 col-lg-4 mb-3';
                        serviceCard.innerHTML = `
                            <div class="card service-card ${cardClass}">
                                <div class="card-body">
                                    <h6 class="card-title">
                                        <span class="status-indicator ${statusClass}"></span>
                                        ${serviceName.replace('_', ' ').toUpperCase()}
                                    </h6>
                                    <p class="card-text">
                                        <small class="text-muted">URL: ${info.url}</small><br>
                                        <small class="text-muted">Доступен: ${info.available ? 'Да' : 'Нет'}</small><br>
                                        <small class="text-muted">Статус: ${statusText}</small>
                                    </p>
                                </div>
                            </div>
                        `;
                        servicesGrid.appendChild(serviceCard);
                    });
                })
                .catch(error => {
                    document.getElementById('services-grid').innerHTML = `
                        <div class="col-12">
                            <div class="alert alert-danger">
                                <i class="fas fa-exclamation-triangle"></i> Ошибка загрузки сервисов
                            </div>
                        </div>
                    `;
                });
        }

        function enableMicroservices() {
            if (confirm('Включить микросервисы? Это потребует перезапуска сервера.')) {
                // This would typically be done via a management command or API
                alert('Для включения микросервисов выполните: python manage.py toggle_microservices --enable');
            }
        }

        function disableMicroservices() {
            if (confirm('Отключить микросервисы? Система будет использовать только локальную базу данных.')) {
                alert('Для отключения микросервисов выполните: python manage.py toggle_microservices --disable');
            }
        }

        function refreshStatus() {
            loadCurrentStatus();
            loadServicesStatus();
        }

        function checkHealth() {
            fetch('/api/health/')
                .then(response => response.json())
                .then(data => {
                    const healthyCount = Object.values(data.health).filter(status => status).length;
                    const totalCount = Object.keys(data.health).length;
                    
                    if (healthyCount === totalCount) {
                        alert('✅ Все сервисы работают нормально!');
                    } else {
                        alert(`⚠️ Работают только ${healthyCount} из ${totalCount} сервисов`);
                    }
                })
                .catch(error => {
                    alert('❌ Ошибка проверки здоровья сервисов');
                });
        }

        // Auto-refresh every 30 seconds
        setInterval(refreshStatus, 30000);
    </script>
</body>
</html>
