# Настройка и запуск микросервисов SvoiCode

## Обзор

Проект SvoiCode теперь поддерживает микросервисную архитектуру. Основное Django приложение работает на порту 8000, а микросервисы работают на портах 8001-8009.

## Архитектура

```
┌─────────────────┐    ┌─────────────────┐    ┌─────────────────┐
│   Main Django   │    │  API Gateway    │    │  Microservices  │
│   (Port 8000)   │◄──►│  (Port 9000)    │◄──►│ (Ports 8001-9)  │
└─────────────────┘    └─────────────────┘    └─────────────────┘
```

### Микросервисы:

- **user_service** (8001) - Управление пользователями
- **incident_service** (8002) - Управление инцидентами и обращениями
- **traffic_service** (8003) - Управление трафиком, камерами, детекторами
- **news_service** (8004) - Управление новостями и статьями
- **chat_service** (8005) - Система чатов
- **analytics_service** (8006) - Аналитика и статистика
- **traffic_analytics_service** (8007) - Аналитика трафика
- **schedule_service** (8008) - Управление расписанием
- **notification_service** (8009) - Уведомления
- **api_gateway** (9000) - API Gateway

## Быстрый запуск

### Вариант 1: Запуск всего сразу
```bash
python start_all.py
```

### Вариант 2: Пошаговый запуск

1. **Запуск микросервисов:**
```bash
python start_microservices.py
```

2. **В новом терминале - запуск основного приложения:**
```bash
python start_main_app.py
```

### Вариант 3: Проверка статуса
```bash
python check_services.py
```

## Настройка

### 1. Установка зависимостей

```bash
# Создание виртуального окружения
python -m venv venv

# Активация (Windows)
venv\Scripts\activate

# Активация (Linux/Mac)
source venv/bin/activate

# Установка зависимостей
pip install -r requirements.txt
```

### 2. Настройка микросервисов

Микросервисы уже настроены в `SvoiCode/settings.py`:

```python
MICROSERVICES = {
    'user_service': 'http://127.0.0.1:8001',
    'incident_service': 'http://127.0.0.1:8002',
    'traffic_service': 'http://127.0.0.1:8003',
    'news_service': 'http://127.0.0.1:8004',
    'chat_service': 'http://127.0.0.1:8005',
    'analytics_service': 'http://127.0.0.1:8006',
    'traffic_analytics_service': 'http://127.0.0.1:8007',
    'schedule_service': 'http://127.0.0.1:8008',
    'notification_service': 'http://127.0.0.1:8009',
}

USE_MICROSERVICES = True  # Включить микросервисы
```

## Использование

### Основной сайт
- **URL:** http://localhost:8000
- **Описание:** Основной веб-интерфейс Django

### API Gateway
- **URL:** http://localhost:9000
- **Описание:** Центральная точка для всех API запросов

### Микросервисы
- **URLs:** http://localhost:8001-8009
- **Описание:** Отдельные сервисы для различных функций

## Fallback механизм

Если микросервис недоступен, система автоматически переключается на локальную базу данных Django. Это обеспечивает непрерывную работу даже при сбоях микросервисов.

## Мониторинг

### Проверка статуса сервисов
```bash
python check_services.py
```

### Логи
Каждый микросервис выводит свои логи в консоль. Основное приложение Django также ведет логи.

## Отладка

### Проблемы с запуском

1. **Порт занят:**
   - Проверьте, что порты 8000-8009 свободны
   - Используйте `netstat -an | findstr :8000` (Windows) или `lsof -i :8000` (Linux/Mac)

2. **Микросервис не отвечает:**
   - Проверьте логи микросервиса
   - Убедитесь, что все зависимости установлены
   - Проверьте настройки в `settings.py`

3. **Fallback не работает:**
   - Убедитесь, что `USE_MICROSERVICES = True`
   - Проверьте настройки в `app/utils/microservice_decorators.py`

### Логи и мониторинг

- Все сервисы выводят логи в консоль
- Django логи можно настроить в `settings.py`
- Используйте `check_services.py` для мониторинга

## Разработка

### Добавление нового микросервиса

1. Создайте папку в `services/`
2. Добавьте конфигурацию в `SvoiCode/settings.py`
3. Создайте клиент в `app/services/`
4. Добавьте в `start_microservices.py`

### Модификация существующих сервисов

1. Измените код в соответствующей папке `services/`
2. Перезапустите сервис
3. Проверьте интеграцию через `check_services.py`

## Остановка

Для остановки всех сервисов нажмите `Ctrl+C` в терминале, где запущены микросервисы.

## Производительность

- Микросервисы работают независимо
- Fallback на локальную БД обеспечивает надежность
- API Gateway может кэшировать запросы
- Каждый сервис может масштабироваться отдельно
